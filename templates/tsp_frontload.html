{% extends "base.html" %}
{% block title %}TSP Front-Loading Estimator{% endblock %}
{% block content %}
<h2 class="mb-3">TSP Front-Loading Estimator üöÄ</h2>
<p class="text-muted" style="font-size: 0.95rem;">
  This tool compares two strategies for reaching your TSP investment goal: front-loading (maximizing early contributions) vs. even contributions throughout the year.
  You‚Äôll still contribute the minimum to earn the full agency match in both cases.
</p>

{% if not result %}
<!-- === FORM === -->
<form method="POST" class="mb-4 needs-validation" novalidate>
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Annual Salary ($)</label>
      <input type="number" class="form-control" name="annual_salary" step="0.01" required value="{{ values.get('annual_salary', '') }}">
    </div>
    <div class="col-md-6">
      <label class="form-label">Agency Match (%)</label>
      <input type="number" class="form-control" name="match_percent" step="0.01" min="0" max="10" required value="{{ values.get('match_percent', '5') }}">
    </div>
    <div class="col-md-6">
      <label class="form-label">Target Investment ($)</label>
      <input type="number" class="form-control" name="target_investment" step="0.01" required value="{{ values.get('target_investment', '23500') }}">
    </div>
    <div class="col-md-6">
      <label class="form-label">Max Per-Pay Contribution ($)</label>
      <input type="number" class="form-control" name="max_biweekly" step="0.01" required value="{{ values.get('max_biweekly', '') }}">
    </div>
    <div class="col-md-6">
      <label class="form-label">Estimated Annual Growth (%)</label>
      <input type="number" class="form-control" name="growth_rate" step="0.01" required value="{{ values.get('growth_rate', '6') }}">
    </div>
    <div class="col-md-6 form-check mt-4">
      <input class="form-check-input" type="checkbox" name="include_match_in_growth" value="yes"
        {% if values.get('include_match_in_growth') == 'yes' %}checked{% endif %}>
      <label class="form-check-label">
        Include agency match in growth calculations
      </label>
    </div>
  </div>
  <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
    <button type="submit" class="btn btn-primary">Estimate</button>
    <a href="/" class="btn btn-outline-secondary">Back to Home</a>
  </div>
</form>

<script>
(function () {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', e => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>

{% else %}
<!-- === RESULTS === -->

<div class="alert alert-info">
  <strong>${{ result["front_ending_balance"] }}</strong> vs. Even Contributions: <strong>${{ result["even_ending_balance"] }}</strong>. 
  Advantage: <strong>${{ result["advantage"] }}</strong>
</div>

<!-- Inputs Summary -->
<div class="card mb-4">
  <div class="card-header fw-bold fs-5">üìã Inputs Used</div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item">Annual Salary: ${{ values["annual_salary"] }}</li>
    <li class="list-group-item">Agency Match %: {{ values["match_percent"] }}%</li>
    <li class="list-group-item">Target Investment: ${{ values["target_investment"] }}</li>
    <li class="list-group-item">Max Per-Pay Contribution: ${{ values["max_biweekly"] }}</li>
    <li class="list-group-item">Annual Growth Estimate: {{ values["growth_rate"] }}%</li>
  </ul>
</div>

<!-- Strategy Summary -->
<div class="card mb-4">
  <div class="card-header fw-bold fs-5">üßÆ Contribution Strategy Summary</div>
  <div class="card-body">
    <ul class="mb-2">
      <li>Contribute <strong>${{ result["match_per_period"] }}</strong> each pay period to get the full agency match.</li>
      <li>Front-load with <strong>${{ result["max_biweekly"] }}</strong> for <strong>{{ result["front_load_periods"] }}</strong> pay periods.</li>
      {% if result["one_off_amount"] > result["match_per_period"] %}
        <li>Then contribute <strong>${{ result["one_off_amount"] }}</strong> for 1 pay period to reach the target.</li>
        <li>After that, continue contributing <strong>${{ result["match_per_period"] }}</strong> for the remaining <strong>{{ result["match_only_periods"] }}</strong> pay periods.</li>
      {% else %}
        <li>Then simply contribute <strong>${{ result["match_per_period"] }}</strong> for the remaining <strong>{{ result["match_only_periods"] + 1 }}</strong> pay periods.</li>
      {% endif %}
    </ul>
    <p class="text-muted mb-0">
      {% if values.get('include_match_in_growth') == 'yes' %}
        Agency match contributions <strong>were included</strong> in growth calculations.
      {% else %}
        Agency match contributions <strong>were not included</strong> in growth calculations.
      {% endif %}
    </p>
  </div>
</div>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<canvas id="frontloadChart" class="mb-5" height="100"></canvas>
<script>
  const labels = JSON.parse('{{ chart_data.labels | tojson | safe }}');
  const front = JSON.parse('{{ chart_data.front | tojson | safe }}');
  const even = JSON.parse('{{ chart_data.even | tojson | safe }}');

  const ctx = document.getElementById("frontloadChart").getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels.map(p => `PP ${p}`),
      datasets: [
        {
          label: 'Front-Loaded Strategy',
          data: front,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          fill: true
        },
        {
          label: 'Even Contributions',
          data: even,
          borderColor: '#198754',
          backgroundColor: 'rgba(25, 135, 84, 0.1)',
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'TSP Growth Over Time' },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString()}`
          }
        },
        legend: { position: 'bottom' }
      },
      scales: {
        y: {
          beginAtZero: false,
          ticks: {
            callback: v => '$' + v.toLocaleString()
          }
        }
      }
    }
  });
</script>

<!-- Breakdown Table -->
<div class="table-responsive mt-5">
  <h4>üìä Pay Period Breakdown</h4>
  <button class="btn btn-sm btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#detailsTable" aria-expanded="false">
    Show Full Table
  </button>

  <div class="collapse" id="detailsTable">
    <table class="table table-bordered table-striped table-sm">
      <thead class="table-light">
        <tr>
          <th>PP</th>
          <th>Front Start</th>
          <th>Front Contribution</th>
          <th>Front End</th>
          <th>Even Start</th>
          <th>Even Contribution</th>
          <th>Even End</th>
          <th>Type
            <span data-bs-toggle="tooltip" title="Front-Load = Max early contributions. One-Off = Final top-up. Match Only = Minimum to get match." style="cursor: help;">‚ÑπÔ∏è</span>
          </th>
          <th>Cumulative Front</th>
          <th>Cumulative Even</th>
        </tr>
      </thead>
      <tbody>
        {% for row in table %}
        <tr>
          <td>{{ row['PP'] }}</td>
          <td>${{ '{:,.2f}'.format(row['Front Begin']) }}</td>
          <td>${{ '{:,.2f}'.format(row['Front Additions']) }}</td>
          <td>${{ '{:,.2f}'.format(row['Front End']) }}</td>
          <td>${{ '{:,.2f}'.format(row['Even Begin']) }}</td>
          <td>${{ '{:,.2f}'.format(row['Even Additions']) }}</td>
          <td>${{ '{:,.2f}'.format(row['Even End']) }}</td>
          <td>
            <span class="{% if row['Contribution Type'] == 'Front-Load (Max)' %}text-primary fw-bold
                         {% elif row['Contribution Type'] == 'One-Off Remainder' %}text-warning fw-bold
                         {% else %}text-muted{% endif %}">
              {{ row['Contribution Type'] }}
            </span>
          </td>
          <td>${{ '{:,.2f}'.format(row['Cumulative Contribution Front']) }}</td>
          <td>${{ '{:,.2f}'.format(row['Cumulative Contribution Even']) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="mt-2 mb-4">
  <small class="text-muted">
    Legend: 
    <span class="fw-bold text-primary">Front-Load (Max)</span> = Max allowed per period.
    <span class="fw-bold text-warning">One-Off Remainder</span> = Final partial top-up.
    <span class="text-muted">Match Only</span> = Minimum for agency match.
  </small>
</div>

<div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
  <a href="/tsp-frontload" class="btn btn-outline-secondary">Back to Calculator</a>
  <a href="/" class="btn btn-outline-primary">Back to Home</a>
</div>
{% endif %}
{% endblock %}
