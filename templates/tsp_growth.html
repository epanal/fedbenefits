{% extends "base.html" %}
{% block title %}TSP Growth Calculator{% endblock %}
{% block content %}

<h2 class="mb-3">TSP Growth Calculator ðŸ“ˆ</h2>

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if not result %}
<form method="POST" class="mb-4" novalidate>
  <!-- Shared inputs -->
  <div class="mb-3">
    <label class="form-label">Current Account Balance ($)</label>
    <input type="number" step="0.01" min="0" class="form-control" name="current_balance" required
           value="{{ values.get('current_balance','') }}">
  </div>

  <div class="mb-3">
    <label class="form-label">Annual Salary ($)</label>
    <input type="number" step="0.01" min="0" class="form-control" name="annual_salary" required
           value="{{ values.get('annual_salary','') }}">
  </div>

  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Years Until Retirement</label>
      <input type="number" min="0" class="form-control" name="years" required
             value="{{ values.get('years','') }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">Expected Annual Return (%)</label>
      <input type="number" step="0.01" class="form-control" name="annual_rate" required
             value="{{ values.get('annual_rate','') }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">Inflation (%)</label>
      <input type="number" step="0.01" class="form-control" name="inflation_rate" required
             value="{{ values.get('inflation_rate','') }}">
    </div>
  </div>

  <hr class="my-4">

  <!-- Contribution type radios -->
  <div class="mb-2">
    <label class="form-label">Contribution Type</label><br>
    <div class="form-check form-check-inline">
      <input class="form-check-input" id="modePercent" type="radio" name="contribution_type" value="percent"
             {% if values.get('contrib_mode','percent') == 'percent' %}checked{% endif %}>
      <label class="form-check-label" for="modePercent">Percentage of Salary</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" id="modeDollar" type="radio" name="contribution_type" value="dollar"
             {% if values.get('contrib_mode') == 'dollar' %}checked{% endif %}>
      <label class="form-check-label" for="modeDollar">Dollar Amount (annual)</label>
    </div>
  </div>

  <!-- Percent mode fields -->
  <div id="mode-percent" class="border rounded p-3 mb-3">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Employee Contribution (%)</label>
        <input id="employee_percent" type="number" step="0.01" min="0" max="100"
               class="form-control" name="contribution_percent"
               value="{{ values.get('employee_percent','') }}">
        <div class="form-text">0â€“100</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Employer Match (%)</label>
        <input id="employer_percent" type="number" step="0.01" min="0" max="100"
               class="form-control" name="employer_percent"
               value="{{ values.get('employer_percent','') }}">
        <div class="form-text">0â€“100</div>
      </div>
    </div>
  </div>

  <!-- Dollar mode fields -->
  <div id="mode-dollar" class="border rounded p-3 mb-3">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Annual Employee Dollars ($)</label>
        <input id="contribution_dollar" type="number" step="0.01" min="0"
               class="form-control" name="contribution_dollar"
               value="{{ values.get('contribution_dollar','') }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Annual Employer Dollars ($)</label>
        <input id="employer_amount" type="number" step="0.01" min="0"
               class="form-control" name="employer_amount"
               value="{{ values.get('employer_amount','') }}">
      </div>
    </div>
  </div>

  <div class="d-grid gap-2 d-md-flex">
    <button type="submit" class="btn btn-primary">Calculate</button>
    <a href="/" class="btn btn-outline-secondary">Back to Home</a>
  </div>
</form>

<script>
(function () {
  function setMode(mode) {
    const percentWrap = document.getElementById('mode-percent');
    const dollarWrap  = document.getElementById('mode-dollar');
    const percentInputs = percentWrap.querySelectorAll('input');
    const dollarInputs  = dollarWrap.querySelectorAll('input');

    const activate = (nodes) => nodes.forEach(i => { i.disabled = false; i.required = true; i.setCustomValidity(''); });
    const deactivate = (nodes) => nodes.forEach(i => { i.disabled = true; i.required = false; i.setCustomValidity(''); });

    if (mode === 'percent') {
      activate(percentInputs); deactivate(dollarInputs);
      percentWrap.style.display = ''; dollarWrap.style.display = 'none';
    } else {
      activate(dollarInputs); deactivate(percentInputs);
      percentWrap.style.display = 'none'; dollarWrap.style.display = '';
    }
  }

  const radios = document.querySelectorAll('input[name="contribution_type"]');
  radios.forEach(r => r.addEventListener('change', () => setMode(r.value)));

  // initialize on load
  const selected = document.querySelector('input[name="contribution_type"]:checked');
  setMode(selected ? selected.value : 'percent');
})();
</script>

{% else %}
<!-- Disclaimer -->
<p class="text-muted mt-3" style="font-size: 12px;">
  *This is a simplified projection. It does not account for changes in contribution limits, unexpected market events, or tax implications.*
</p>

<!-- Inputs Used -->
<div class="card mb-4">
  <div class="card-header fw-bold fs-5">ðŸ“‹ Inputs Used</div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item">Current Balance: ${{ "{:,.2f}".format(current_balance) }}</li>
    <li class="list-group-item">Annual Salary: ${{ "{:,.2f}".format(annual_salary) }}</li>

    {% if contrib_mode == "percent" %}
      <li class="list-group-item">Employee Contribution: {{ employee_percent }}% of salary</li>
      <li class="list-group-item">Employer Match: {{ employer_percent }}% of salary</li>
    {% else %}
      <li class="list-group-item">Employee Contribution: ${{ "{:,.2f}".format(contribution_dollar) }} per year</li>
      <li class="list-group-item">Employer Match: ${{ "{:,.2f}".format(employer_amount) }} per year</li>
    {% endif %}

    <li class="list-group-item">Years Until Retirement: {{ years }}</li>
    <li class="list-group-item">Expected Annual Return: {{ annual_rate }}%</li>
    <li class="list-group-item">Expected Inflation: {{ inflation_rate }}%</li>
  </ul>
</div>

<!-- Results -->
<div class="card mb-4">
  <div class="card-header fw-bold fs-5">ðŸ“Š Results</div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item">
      Future Balance (Nominal): 
      <span class="fw-bold text-primary">${{ "{:,.2f}".format(result.future_value_nominal) }}</span>
    </li>
    <li class="list-group-item">
      Future Balance (Todayâ€™s Dollars): 
      <span class="fw-bold text-success">${{ "{:,.2f}".format(result.future_value_real) }}</span>
    </li>
    <li class="list-group-item">Total Contributions: ${{ "{:,.2f}".format(result.total_contributions) }}</li>
    <li class="list-group-item">Total Growth: ${{ "{:,.2f}".format(result.growth) }}</li>
  </ul>
</div>

<!-- Chart -->
<script id="yearly-data" type="application/json">
  {{ result.yearly_data | tojson }}
</script>

<div style="height: 400px;" class="mb-4">
  <canvas id="growthChart"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const yearlyData = JSON.parse(document.getElementById('yearly-data').textContent);
const labels = yearlyData.map(item => item.year);
const contributions = yearlyData.map(item => item.contributions);
const growth = yearlyData.map(item => item.growth);

new Chart(document.getElementById('growthChart'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Contributions',
        data: contributions,
        backgroundColor: '#28a745',
        stack: 'stack1'
      },
      {
        label: 'Growth',
        data: growth,
        backgroundColor: '#ffc107',
        stack: 'stack1'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      title: {
        display: true,
        text: 'Year-by-Year TSP Growth (Nominal)'
      },
      tooltip: {
        callbacks: {
          label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString()}`
        }
      },
      legend: { position: 'bottom' }
    },
    scales: {
      x: { stacked: true },
      y: { 
        stacked: true,
        beginAtZero: true,
        ticks: { callback: v => '$' + v.toLocaleString() }
      }
    }
  }
});
</script>

<!-- Navigation -->
<div class="d-grid gap-2 d-md-flex justify-content-md-start mt-3">
  <a href="/tsp-growth" class="btn btn-outline-secondary">Back to Calculator</a>
  <a href="/" class="btn btn-outline-primary">Back to Home</a>
</div>
{% endif %}
{% endblock %}
